<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Create and Register Fleets and Authenticate Devices - Amazon SageMaker</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="edge-getting-started-step3" /><meta name="default_state" content="edge-getting-started-step3" /><link rel="icon" type="image/ico" href="../../../assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="../../../assets/images/favicon.ico" /><link rel="canonical" href="edge-getting-started-step3.html" /><meta name="description" content="In this section you will create your AWS IoT thing object, create a device fleet, register your device fleet so it can interact with the cloud, create X.509 certificates to authenticate your devices to AWS IoT Core, associate the role alias with AWS IoT that was generated when you created your fleet, get your AWS account-specific endpoint for the credentials provider, get an official Amazon Root CA file, and upload the Amazon CA file to Amazon S3." /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon SageMaker" /><meta name="guide" content="Developer Guide" /><meta name="abstract" content="Use Internet Monitor to build, train, and host machine learning models in AWS." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="edge-getting-started-step3.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="de" /><link rel="alternative" href="edge-getting-started-step3.html" hreflang="en-us" /><link rel="alternative" href="edge-getting-started-step3.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/sagemaker/latest/dg/edge-getting-started-step3.html" hreflang="zh-tw" /><link rel="alternative" href="edge-getting-started-step3.html" hreflang="x-default" /><meta name="feedback-item" content="SageMaker" /><meta name="this_doc_product" content="Amazon SageMaker" /><meta name="this_doc_guide" content="Developer Guide" /><script defer="" src="../../../assets/r/vendor4.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/vendor3.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/vendor1.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/awsdocs-common.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/awsdocs-doc-page.js@version=2021.12.02"></script><link href="../../../assets/r/vendor4.css@version=2021.12.02.css" rel="stylesheet" /><link href="../../../assets/r/awsdocs-common.css@version=2021.12.02.css" rel="stylesheet" /><link href="../../../assets/r/awsdocs-doc-page.css@version=2021.12.02.css" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'sagemaker'}"></script><meta id="panorama-serviceSubSection" value="Developer Guide" /><meta id="panorama-serviceConsolePage" value="Create and Register Fleets and Authenticate Devices" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Create and Register Fleets and Authenticate Devices - Amazon SageMaker</title><meta name="pdf" content="/pdfs/sagemaker/latest/dg/sagemaker-dg.pdf#edge-getting-started-step3" /><meta name="rss" content="amazon-sagemaker-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=285" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/edge-getting-started-step3.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/edge-getting-started-step3.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/edge-getting-started-step3.html" /><meta name="keywords" content="SageMaker,Amazon SageMaker,machine learning,notebook instance,inference,deploy model,endpoint,prediction,ML application,serverless machine learning,multi model deployment,inference pipelines,ML model" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon SageMaker",
        "item" : "https://docs.aws.amazon.com/sagemaker/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Developer Guide",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Deploy models for inference",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/deploy-model.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Deploy models at the edge with SageMaker Edge Manager",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/edge.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Getting Started",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/edge-manager-getting-started.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "Create and Register Fleets and Authenticate Devices",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/edge-manager-getting-started.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="https://docs.aws.amazon.com/pdfs/sagemaker/latest/dg/sagemaker-dg.pdf#edge-getting-started-step3" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="https://docs.aws.amazon.com/index.html">Documentation</a><a href="https://docs.aws.amazon.com/sagemaker/index.html">Amazon SageMaker</a><a href="whatis.html">Developer Guide</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="edge-getting-started-step3">Create and Register Fleets and Authenticate
                Devices</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>In this section you will create your AWS IoT thing object, create a device fleet,
            register your device fleet so it can interact with the cloud, create X.509 certificates
            to authenticate your devices to AWS IoT Core, associate the role alias with AWS IoT that was
            generated when you created your fleet, get your AWS account-specific endpoint for the
            credentials provider, get an official Amazon Root CA file, and upload the Amazon CA file
            to Amazon S3.</p><div class="procedure"><ol><li>
                <p><b>Create AWS IoT things.</b></p>
                <p>SageMaker Edge Manager takes advantage of the AWS IoT Core services to facilitate the
                    connection between the edge devices and endpoints in the AWS cloud. You can
                    take advantage of existing AWS IoT functionality after you set up your devices to
                    work with Edge Manager.</p>
                <p>To connect your device to AWS IoT, you need to create AWS IoT <em>thing objects</em>, create and register a client
                    certificate with AWS IoT, and create and configure the IAM role for your
                    devices.</p>
                <p>First, create AWS IoT thing objects with the AWS IoT client
                        (<code class="code">iot_client</code>) you created earlier with Boto3. The following
                    example shows how to create two thing objects:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">iot_thing_name = 'sample-device'
iot_thing_type = 'getting-started-demo'

iot_client.create_thing_type(
    thingTypeName=iot_thing_type
)

# Create an AWS IoT thing objects
iot_client.create_thing(
    thingName=iot_thing_name,
    thingTypeName=iot_thing_type
)</code></pre>
            </li><li>
                <p><b>Create your device fleet.</b></p>
                <p>Create a device fleet with the SageMaker client object defined in a previous step.
                    You can also use the SageMaker console to create a device fleet.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">import time
device_fleet_name="demo-device-fleet" + str(time.time()).split('.')[0]
device_name="sagemaker-edge-demo-device" + str(time.time()).split('.')[0]</code></pre>
                <p>Specify your IoT role ARN. This lets AWS IoT grant temporary credentials to
                    devices.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">device_model_directory='device_output'
s3_device_fleet_output = 's3://<span>{</span>}/<span>{</span>}'.format(bucket, device_model_directory)

sagemaker_client.create_device_fleet(
    DeviceFleetName=device_fleet_name,
    RoleArn=iot_role_arn, # IoT Role ARN specified in previous step
    OutputConfig=<span>{</span>
        'S3OutputLocation': s3_device_fleet_output
    }
)</code></pre>
                <p>An AWS IoT role alias is created when you create a device fleet. This role alias
                    is associated with AWS IoT using the <code class="code">iot_client</code> object in a later
                    step.</p>
            </li><li>
                <p><b>Register your device fleet.</b></p>
                <p>To interact with the cloud, you need to register your device with
                    SageMaker Edge Manager. In this example, you register a single device with the fleet you
                    created. To register the device, you need to provide a device name and the AWS IoT
                    thing name as shown in the following example:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python "># Device name should be 36 characters
device_name = "sagemaker-edge-demo-device" + str(time.time()).split('.')[0]

sagemaker_client.register_devices(
    DeviceFleetName=device_fleet_name,
    Devices=[
        <span>{</span>
            "DeviceName": device_name,
            "IotThingName": iot_thing_name
        }
    ]
)</code></pre>
            </li><li>
                <p><b>Create X.509 certificates.</b></p>
                <p>After creating the AWS IoT thing object, you must create a X.509 device
                    certificate for your thing object. This certificate authenticates your device to
                    AWS IoT Core.</p>
                <p>Use the following to create a private key, public key, and a X.509 certificate
                    file using the AWS IoT client defined (<code class="code">iot_client</code>) earlier.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python "># Creates a 2048-bit RSA key pair and issues an X.509 # certificate 
# using the issued public key.
create_cert = iot_client.create_keys_and_certificate(
    setAsActive=True 
)

# Get certificate from dictionary object and save in its own
with open('./device.pem.crt', 'w') as f:
    for line in create_cert['certificatePem'].split('\n'):
        f.write(line)
        f.write('\n')
# Get private key from dictionary object and save in its own 
with open('./private.pem.key', 'w') as f:
    for line in create_cert['keyPair']['PrivateKey'].split('\n'):
        f.write(line)
        f.write('\n')
# Get a private key from dictionary object and save in its own 
with open('./public.pem.key', 'w') as f:
    for line in create_cert['keyPair']['PublicKey'].split('\n'):
        f.write(line)
        f.write('\n')</code></pre>
            </li><li>
                <p><b>Associate the role alias with AWS IoT.</b></p>
                <p>When you create a device fleet with SageMaker
                        (<code class="code">sagemaker_client.create_device_fleet()</code>), a role alias is
                    generated for you. An AWS IoT role alias provides a mechanism for connected
                    devices to authenticate to AWS IoT using X.509 certificates, and then obtain
                    short-lived AWS credentials from an IAM role that is associated with an AWS IoT
                    role alias. The role alias allows you to change the role of the device without
                    having to update the device. Use <code class="code">DescribeDeviceFleet</code> to get the
                    role alias name and ARN.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python "># Print Amazon Resource Name (ARN) and alias that has access 
# to AWS Internet of Things (IoT).
sagemaker_client.describe_device_fleet(DeviceFleetName=device_fleet_name)

# Store iot role alias string in a variable
# Grabs role ARN
full_role_alias_name = sagemaker_client.describe_device_fleet(DeviceFleetName=device_fleet_name)['IotRoleAlias']
start_index = full_role_alias_name.find('SageMaker') # Find beginning of role name  
role_alias_name = full_role_alias_name[start_index:] </code></pre>
                <p>Use the <code class="code">iot_client</code> to facilitate associating the role alias
                    generated from creating the device fleet with AWS IoT:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">role_alias = iot_client.describe_role_alias(
                    roleAlias=role_alias_name)</code></pre>
                <p>For more information about IAM role alias, see <a href="https://docs.aws.amazon.com/iot/latest/developerguide/audit-chk-role-alias-unused-svcs.html">Role
                        alias allows access to unused services</a> .</p>
                <p>You created and registered a certificate with AWS IoT earlier for successful
                    authentication of your device. Now, you need to create and attach a policy to
                    the certificate to authorize the request for the security token.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">alias_policy = <span>{</span>
  "Version": "2012-10-17",
  "Statement": <span>{</span>
    "Effect": "Allow",
    "Action": "iot:AssumeRoleWithCertificate",
    "Resource": role_alias['roleAliasDescription']['roleAliasArn']
  }
}

policy_name = 'aliaspolicy-'+ str(time.time()).split('.')[0]
aliaspolicy = iot_client.create_policy(policyName=policy_name,
                                       policyDocument=json.dumps(alias_policy))

# Attach policy
iot_client.attach_policy(policyName=policy_name,
                            target=create_cert['certificateArn'])</code></pre>
            </li><li>
                <p><b>Get your AWS account-specific endpoint for the
                        credentials provider.</b></p>
                <p>Edge devices need an endpoint in order to assume credentials. Obtain your
                    AWS account-specific endpoint for the credentials provider.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python "># Get the unique endpoint specific to your AWS account that is making the call.
iot_endpoint = iot_client.describe_endpoint(
    endpointType='iot:CredentialProvider'
)

endpoint="https://<span>{</span>}/role-aliases/<span>{</span>}/credentials".format(iot_endpoint['endpointAddress'],role_alias_name)</code></pre>
            </li><li>
                <p><b>Get the official Amazon root CA file and upload it to
                        the Amazon S3 bucket.</b></p>
                <p>Use the following in your Jupyter Notebook or AWS CLI (if you use your terminal,
                    remove the ‘!’ magic function):</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">!wget https://www.amazontrust.com/repository/AmazonRootCA1.pem</code></pre>
                <p>Use the endpoint to make an HTTPS request to the credentials provider to
                    return a security token. The following example command uses <code class="code">curl</code>,
                    but you can use any HTTP client.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">!curl --cert device.pem.crt --key private.pem.key --cacert AmazonRootCA1.pem $endpoint</code></pre>
                <p>If the certificate is verified, upload the keys and certificate to your Amazon S3
                    bucket URI:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">!aws s3 cp private.pem.key s3://<span>{</span>bucket}/authorization-files/
!aws s3 cp device.pem.crt s3://<span>{</span>bucket}/authorization-files/
!aws s3 cp AmazonRootCA1.pem s3://<span>{</span>bucket}/authorization-files/</code></pre>
                <p>Clean your working directory by moving your keys and certificate to a
                    different directory:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python "># Optional - Clean up working directory
!mkdir authorization-files
!mv private.pem.key device.pem.crt AmazonRootCA1.pem authorization-files/</code></pre>
            </li></ol></div><awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="https://docs.aws.amazon.com/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./edge-getting-started-step2.html">Train, Compile, and Package Your
                Model</div><div id="next" class="next-link" accesskey="n" href="./edge-getting-started-step4.html">Download and Set Up Edge Manager</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=https://docs.aws.amazon.com/en_us/sagemaker/latest/dg/edge-getting-started-step3.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=https://docs.aws.amazon.com/en_us/sagemaker/latest/dg/edge-getting-started-step3.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>