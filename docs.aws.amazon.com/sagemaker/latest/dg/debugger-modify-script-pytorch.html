<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Adapt Your PyTorch Training Script - Amazon SageMaker</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="debugger-modify-script-pytorch" /><meta name="default_state" content="debugger-modify-script-pytorch" /><link rel="icon" type="image/ico" href="../../../assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="../../../assets/images/favicon.ico" /><link rel="canonical" href="debugger-modify-script-pytorch.html" /><meta name="description" content="To start collecting model output tensors and debug training issues, make the following modifications to your PyTorch training script." /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon SageMaker" /><meta name="guide" content="Developer Guide" /><meta name="abstract" content="Use Internet Monitor to build, train, and host machine learning models in AWS." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="debugger-modify-script-pytorch.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="de" /><link rel="alternative" href="debugger-modify-script-pytorch.html" hreflang="en-us" /><link rel="alternative" href="debugger-modify-script-pytorch.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/sagemaker/latest/dg/debugger-modify-script-pytorch.html" hreflang="zh-tw" /><link rel="alternative" href="debugger-modify-script-pytorch.html" hreflang="x-default" /><meta name="feedback-item" content="SageMaker" /><meta name="this_doc_product" content="Amazon SageMaker" /><meta name="this_doc_guide" content="Developer Guide" /><script defer="" src="../../../assets/r/vendor4.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/vendor3.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/vendor1.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/awsdocs-common.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/awsdocs-doc-page.js@version=2021.12.02"></script><link href="../../../assets/r/vendor4.css@version=2021.12.02.css" rel="stylesheet" /><link href="../../../assets/r/awsdocs-common.css@version=2021.12.02.css" rel="stylesheet" /><link href="../../../assets/r/awsdocs-doc-page.css@version=2021.12.02.css" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'sagemaker'}"></script><meta id="panorama-serviceSubSection" value="Developer Guide" /><meta id="panorama-serviceConsolePage" value="Adapt Your PyTorch Training Script" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Adapt Your PyTorch Training Script - Amazon SageMaker</title><meta name="pdf" content="/pdfs/sagemaker/latest/dg/sagemaker-dg.pdf#debugger-modify-script-pytorch" /><meta name="rss" content="amazon-sagemaker-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=285" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/debugger-modify-script-pytorch.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/debugger-modify-script-pytorch.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/debugger-modify-script-pytorch.html" /><meta name="keywords" content="SageMaker,Amazon SageMaker,machine learning,notebook instance" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon SageMaker",
        "item" : "https://docs.aws.amazon.com/sagemaker/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Developer Guide",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Train machine learning models",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/train-model.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Debug and improve model performance",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/train-debug-and-improve-model-performance.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Use Amazon SageMaker Debugger to debug and improve model performance",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/train-debugger.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "Debug Training Jobs Using Amazon SageMaker Debugger",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/debugger-debug-training-jobs.html"
      },
      {
        "@type" : "ListItem",
        "position" : 8,
        "name" : "Step 1: Adapt Your Training Script to Register a Hook",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/debugger-modify-script.html"
      },
      {
        "@type" : "ListItem",
        "position" : 9,
        "name" : "Adapt Your PyTorch Training Script",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/debugger-modify-script.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="https://docs.aws.amazon.com/pdfs/sagemaker/latest/dg/sagemaker-dg.pdf#debugger-modify-script-pytorch" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="https://docs.aws.amazon.com/index.html">Documentation</a><a href="https://docs.aws.amazon.com/sagemaker/index.html">Amazon SageMaker</a><a href="whatis.html">Developer Guide</a></div><div id="page-toc-src"><a href="debugger-modify-script-pytorch.html#debugger-modify-script-pytorch-1-12-0">PyTorch 1.12.0</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="debugger-modify-script-pytorch">Adapt Your PyTorch Training
                Script</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>To start collecting model output tensors and debug training issues, make the following
            modifications to your PyTorch training script.</p>
            <h2 id="debugger-modify-script-pytorch-1-12-0">For PyTorch 1.12.0</h2>
            <p>If you bring a PyTorch training script, you can run the training job and extract
                model output tensors with a few additional code lines in your training script. You
                need to use the <a href="https://sagemaker-debugger.readthedocs.io/en/website/hook-api.html" rel="noopener noreferrer" target="_blank"><span>hook
                    APIs</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> in the <code class="code">sagemaker-debugger</code> client library. Walk through
                the following instructions that break down the steps with code examples.</p>
            <div class="orderedlist">
                 
                 
                 
                 
                 
                 
                 
            <ol><li>
                    <p>Create a hook.</p>
                    <p><b>(Recommended) For training jobs within
                            SageMaker</b></p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">import smdebug.pytorch as smd
hook=smd.get_hook(create_if_not_exists=True)</code></pre>
                    <p>When you launch a training job in <a href="debugger-configuration-for-debugging.html">Step 2: Launch and Debug Training
            Jobs Using SageMaker Python SDK</a> with any of the
                        DebuggerHookConfig, TensorBoardConfig, or Rules in your estimator, SageMaker
                        adds a JSON configuration file to your training instance that is picked up
                        by the <code class="code">get_hook</code> function. Note that if you do not include any
                        of the configuration APIs in your estimator, there will be no configuration
                        file for the hook to find, and the function returns
                        <code class="code">None</code>.</p>
                    <p><b>(Optional) For training jobs outside
                            SageMaker</b></p>
                    <p>If you run training jobs in local mode, directly on SageMaker Notebook
                        instances, Amazon EC2 instances, or your own local devices, use
                            <code class="code">smd.Hook</code> class to create a hook. However, this approach can
                        only store the tensor collections and usable for TensorBoard visualization.
                        SageMaker Debugger’s built-in Rules don’t work with the local mode because the
                        Rules require SageMaker ML training instances and S3 to store outputs from
                        the remote instances in real time. The <code class="code">smd.get_hook</code> API returns
                            <code class="code">None</code> in this case. </p>
                    <p>If you want to create a manual hook to save tensors in local mode, use the
                        following code snippet with the logic to check if the
                            <code class="code">smd.get_hook</code> API returns <code class="code">None</code> and create a
                        manual hook using the <code class="code">smd.Hook</code> class. Note that you can specify
                        any output directory in your local machine.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">import smdebug.pytorch as smd
hook=smd.get_hook(create_if_not_exists=True)

if hook is None:
    hook=smd.Hook(
        out_dir='<code class="replaceable">/path/to/your/local/output/</code>',
        export_tensorboard=True
    )</code></pre>
                </li><li>
                    <p>Wrap your model with the hook’s class methods.</p>
                    <p>The <code class="code">hook.register_module()</code> method takes your model and
                        iterates through each layer, looking for any tensors that match with regular
                        expressions that you’ll provide through the configuration in <a href="debugger-configuration-for-debugging.html">Step 2: Launch and Debug Training
            Jobs Using SageMaker Python SDK</a>. The collectable
                        tensors through this hook method are weights, biases, activations,
                        gradients, inputs, and outputs.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">hook.register_module(model)</code></pre>
                    <div class="awsdocs-note awsdocs-tip"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Tip</h6></div><div class="awsdocs-note-text"><p>If you collect the entire output tensors from a large deep learning
                            model, the total size of those collections can exponentially grow and
                            might cause bottlenecks. If you want to save specific tensors, you can
                            also use the <code class="code">hook.save_tensor()</code> method. This method helps
                            you pick the variable for the specific tensor and save to a custom
                            collection named as you want. For more information, see <a href="debugger-modify-script-pytorch.html#debugger-modify-script-pytorch-save-custom-tensor">step
                                7</a> of this instruction.</p></div></div>
                </li><li>
                    <p>Warp the loss function with the hook’s class methods.</p>
                    <p>The <code class="code">hook.register_loss</code> method is to wrap the loss function.
                        It extracts loss values every <code class="code">save_interval</code> that you’ll set
                        during configuration in <a href="debugger-configuration-for-debugging.html">Step 2: Launch and Debug Training
            Jobs Using SageMaker Python SDK</a>, and saves them to the <code class="code">"losses"</code> collection.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">hook.register_loss(loss_function)</code></pre>
                </li><li>
                    <p>Add <code class="code">hook.set_mode(ModeKeys.TRAIN)</code> in the train block. This
                        indicates the tensor collection is extracted during the training
                        phase.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">def train():
    ...
    hook.set_mode(ModeKeys.TRAIN)</code></pre>
                </li><li>
                    <p>Add <code class="code">hook.set_mode(ModeKeys.EVAL)</code> in the validation block.
                        This indicates the tensor collection is extracted during the validation
                        phase.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">def validation():
    ...
    hook.set_mode(ModeKeys.EVAL)</code></pre>
                </li><li>
                    <p>Use <a href="https://sagemaker-debugger.readthedocs.io/en/website/hook-constructor.html#smdebug.core.hook.BaseHook.save_scalar" rel="noopener noreferrer" target="_blank"><span><code class="code">hook.save_scalar()</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> to save custom scalars. You
                        can save scalar values that aren’t in your model. For example, if you want
                        to record the accuracy values computed during evaluation, add the following
                        line of code below the line where you calculate accuracy.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">hook.save_scalar("accuracy", accuracy)</code></pre>
                    <p>Note that you need to provide a string as the first argument to name the
                        custom scalar collection. This is the name that'll be used for visualizing
                        the scalar values in TensorBoard, and can be any string you want.</p>
                </li><li>
                    <p>Use <a href="https://sagemaker-debugger.readthedocs.io/en/website/hook-constructor.html#smdebug.core.hook.BaseHook.save_tensor" rel="noopener noreferrer" target="_blank"><span><code class="code">hook.save_tensor()</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> to save custom tensors.
                        Similarly to <a href="https://sagemaker-debugger.readthedocs.io/en/website/hook-constructor.html#smdebug.core.hook.BaseHook.save_scalar" rel="noopener noreferrer" target="_blank"><span><code class="code">hook.save_scalar()</code></span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, you can save additional
                        tensors, defining your own tensor collection. For example, you can extract
                        input image data that are passed into the model and save as a custom tensor
                        by adding the following code line, where <code class="code">"images"</code> is an example
                        name of the custom tensor, <code class="code">image_inputs</code> is an example variable
                        for the input image data.</p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">hook.save_tensor("images", image_inputs)</code></pre>
                    <p>Note that you must provide a string to the first argument to name the
                        custom tensor. <code class="code">hook.save_tensor()</code> has the third argument
                            <code class="code">collections_to_write</code> to specify the tensor collection to
                        save the custom tensor. The default is
                            <code class="code">collections_to_write="default"</code>. If you don't explicitely
                        specify the third argument, the custom tensor is saved to the
                            <code class="code">"default"</code> tensor collection.</p>
                </li></ol></div>
            <p>After you have completed adapting your training script, proceed to <a href="debugger-configuration-for-debugging.html">Step 2: Launch and Debug Training
            Jobs Using SageMaker Python SDK</a>.</p>
        <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="https://docs.aws.amazon.com/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./debugger-modify-script.html">Step 1: Adapt Your Training Script to Register a Hook</div><div id="next" class="next-link" accesskey="n" href="./debugger-modify-script-tensorflow.html">TensorFlow</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=https://docs.aws.amazon.com/en_us/sagemaker/latest/dg/debugger-modify-script-pytorch.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=https://docs.aws.amazon.com/en_us/sagemaker/latest/dg/debugger-modify-script-pytorch.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>