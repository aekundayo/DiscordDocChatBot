<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Adapting your own training container - Amazon SageMaker</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="adapt-training-container" /><meta name="default_state" content="adapt-training-container" /><link rel="icon" type="image/ico" href="../../../assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="../../../assets/images/favicon.ico" /><link rel="canonical" href="adapt-training-container.html" /><meta name="description" content="To run your own training model, build a Docker container using the Amazon SageMaker Training Toolkit through an Amazon SageMaker notebook instance." /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon SageMaker" /><meta name="guide" content="Developer Guide" /><meta name="abstract" content="Use Internet Monitor to build, train, and host machine learning models in AWS." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="adapt-training-container.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/sagemaker/latest/dg/adapt-training-container.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/sagemaker/latest/dg/adapt-training-container.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/sagemaker/latest/dg/adapt-training-container.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/sagemaker/latest/dg/adapt-training-container.html" hreflang="de" /><link rel="alternative" href="adapt-training-container.html" hreflang="en-us" /><link rel="alternative" href="adapt-training-container.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/sagemaker/latest/dg/adapt-training-container.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/sagemaker/latest/dg/adapt-training-container.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/sagemaker/latest/dg/adapt-training-container.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/sagemaker/latest/dg/adapt-training-container.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/sagemaker/latest/dg/adapt-training-container.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/sagemaker/latest/dg/adapt-training-container.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/adapt-training-container.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/sagemaker/latest/dg/adapt-training-container.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/adapt-training-container.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/sagemaker/latest/dg/adapt-training-container.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/sagemaker/latest/dg/adapt-training-container.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/sagemaker/latest/dg/adapt-training-container.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/sagemaker/latest/dg/adapt-training-container.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/sagemaker/latest/dg/adapt-training-container.html" hreflang="zh-tw" /><link rel="alternative" href="adapt-training-container.html" hreflang="x-default" /><meta name="feedback-item" content="SageMaker" /><meta name="this_doc_product" content="Amazon SageMaker" /><meta name="this_doc_guide" content="Developer Guide" /><script defer="" src="../../../assets/r/vendor4.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/vendor3.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/vendor1.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/awsdocs-common.js@version=2021.12.02"></script><script defer="" src="../../../assets/r/awsdocs-doc-page.js@version=2021.12.02"></script><link href="../../../assets/r/vendor4.css@version=2021.12.02.css" rel="stylesheet" /><link href="../../../assets/r/awsdocs-common.css@version=2021.12.02.css" rel="stylesheet" /><link href="../../../assets/r/awsdocs-doc-page.css@version=2021.12.02.css" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'sagemaker'}"></script><meta id="panorama-serviceSubSection" value="Developer Guide" /><meta id="panorama-serviceConsolePage" value="Adapting your own training container" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Adapting your own training container - Amazon SageMaker</title><meta name="pdf" content="/pdfs/sagemaker/latest/dg/sagemaker-dg.pdf#adapt-training-container" /><meta name="rss" content="amazon-sagemaker-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=285" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/adapt-training-container.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/adapt-training-container.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/sagemaker/latest/dg/adapt-training-container.html" /><meta name="keywords" content="SageMaker,Amazon SageMaker,machine learning,notebook instance" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon SageMaker",
        "item" : "https://docs.aws.amazon.com/sagemaker/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Developer Guide",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Use Docker containers to build models",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/docker-containers.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Adapting your own Docker container to work with SageMaker",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/docker-containers-adapt-your-own.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Adapting your own training container",
        "item" : "https://docs.aws.amazon.com/sagemaker/latest/dg/docker-containers-adapt-your-own.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="https://docs.aws.amazon.com/pdfs/sagemaker/latest/dg/sagemaker-dg.pdf#adapt-training-container" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="https://docs.aws.amazon.com/index.html">Documentation</a><a href="https://docs.aws.amazon.com/sagemaker/index.html">Amazon SageMaker</a><a href="whatis.html">Developer Guide</a></div><div id="page-toc-src"><a href="adapt-training-container.html#byoc-training-step1">Step 1: Create a notebook instance</a><a href="adapt-training-container.html#byoc-training-step2">Step 2: Create and upload training scripts</a><a href="adapt-training-container.html#byoc-training-step3">Step 3: Build the container</a><a href="adapt-training-container.html#byoc-training-step4">Step 4: Test the container</a><a href="adapt-training-container.html#byoc-training-step5">Step 5: Push the container to Amazon ECR</a><a href="adapt-training-container.html#byoc-training-step6">Step 6: Clean up resources</a><a href="adapt-training-container.html#byoc-blogs-and-examples">Blogs and Case Studies</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="adapt-training-container">Adapting your own training container</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>To run your own training model, build a Docker container using the <a href="https://github.com/aws/sagemaker-training-toolkit" rel="noopener noreferrer" target="_blank"><span>Amazon SageMaker Training
            Toolkit</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> through an Amazon SageMaker notebook instance.</p>
        <h2 id="byoc-training-step1">Step 1: Create a SageMaker notebook instance</h2>
        <div class="procedure"><ol><li><p>Open the Amazon SageMaker console at <a href="https://console.aws.amazon.com/sagemaker/" rel="noopener noreferrer" target="_blank"><span>https://console.aws.amazon.com/sagemaker/</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.</p></li><li>
                <p>In the left navigation pane, choose <b>Notebook</b>, choose
                        <b>Notebook instances</b>, and then choose <b>Create
                        notebook instance</b>. </p>
            </li><li>
                <p>On the <b>Create notebook instance</b> page, provide the
                    following information: </p>
                <ol><li>
                        <p>For <b>Notebook instance name</b>, enter
                                <code class="userinput">RunScriptNotebookInstance</code>.</p>
                    </li><li>
                        <p>For <b>Notebook Instance type</b>, choose
                                <code class="userinput">ml.t2.medium</code>.</p>
                    </li><li>
                        <p>In the <b>Permissions and encryption</b> section, do the
                            following:</p>
                        <ol><li>
                                <p>For <b>IAM role</b>, choose <b>Create a
                                        new role</b>. This opens a new window.</p>
                            </li><li>
                                <p>On the <b>Create an IAM role</b> page, choose
                                        <b>Specific S3 buckets</b>, specify an Amazon S3
                                    bucket named <code class="userinput">sagemaker-run-script</code>, and
                                    then choose <b>Create role</b>.</p>
                                <p>SageMaker creates an IAM role named
                                            <code class="code">AmazonSageMaker-ExecutionRole-<code class="replaceable">YYYYMMDD</code>T<code class="replaceable">HHmmSS</code></code>.
                                    For example,
                                        <code>AmazonSageMaker-ExecutionRole-20190429T110788</code>.
                                    Note that the execution role naming convention uses the date and
                                    time at which the role was created, separated by a
                                        <code class="code">T</code>.</p>
                            </li></ol>
                    </li><li>
                        <p>For <b>Root Access</b>, choose
                                <b>Enable</b>.</p>
                    </li><li>
                        <p>Choose <b>Create notebook instance</b>. </p>
                    </li></ol>
            </li><li>
                <p>On the <b>Notebook instances</b> page, the
                        <b>Status</b> is <b>Pending</b>. It can take a
                    few minutes for Amazon SageMaker to launch a machine learning compute instance—in
                    this case, it launches a notebook instance—and attach an ML storage
                    volume to it. The notebook instance has a preconfigured Jupyter notebook server
                    and a set of Anaconda libraries. For more information, see <a href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_CreateNotebookInstance.html">
                        &#x2028;CreateNotebookInstance</a>. </p>
                <p></p>
            </li><li>
                <p>Click on the <b>Name</b> of the notebook you just created. This
                    opens a new page.</p>
            </li><li>
                <p> In the <b>Permissions and encryption</b> section, copy
                        <b>the IAM role ARN number</b>, and paste it into a notepad
                    file to save it temporarily. You use this IAM role ARN number later to
                    configure a local training estimator in the notebook instance. <b>The
                        IAM role ARN number</b> looks like the following:
                        <code class="code">'arn:aws:iam::111122223333:role/service-role/AmazonSageMaker-ExecutionRole-20190429T110788'</code>
                </p>
            </li><li>
                <p>After the status of the notebook instance changes to
                        <b>InService</b>, choose <b>Open
                    JupyterLab</b>.</p>
            </li></ol></div>
     
        <h2 id="byoc-training-step2">Step 2: Create and upload the Dockerfile and
                Python training scripts</h2>
        <div class="procedure"><ol><li>
                <p>After JupyterLab opens, create a new folder in the home directory of your
                    JupyterLab. In the upper-left corner, choose the <b>New Folder</b>
                    icon, and then enter the folder name <code class="code">docker_test_folder</code>. </p>
            </li><li>
                <p>Create a <code class="code">Dockerfile</code> text file in the
                        <code class="code">docker_test_folder</code> directory. </p>
                <ol><li>
                        <p>Choose the <b>New Launcher</b> icon (+) in the
                            upper-left corner. </p>
                    </li><li>
                        <p>In the right pane under the <b>Other</b> section, choose
                                <b>Text File</b>.</p>
                    </li><li>
                        <p>Paste the following <code class="code">Dockerfile</code> sample code into your text
                            file. </p>
                        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">#Download an open source TensorFlow Docker image
FROM tensorflow/tensorflow:latest-gpu-jupyter

# Install sagemaker-training toolkit that contains the common functionality necessary to create a container compatible with SageMaker and the Python SDK.
RUN pip3 install sagemaker-training

# Copies the training code inside the container
COPY train.py /opt/ml/code/train.py

# Defines train.py as script entrypoint
ENV SAGEMAKER_PROGRAM train.py</code></pre>
                        <p>The Dockerfile script performs the following tasks:</p>
                        <div class="itemizedlist">
                             
                             
                             
                             
                        <ul class="itemizedlist"><li class="listitem">
                                <p><code class="code">FROM tensorflow/tensorflow:latest-gpu-jupyter</code>
                                    – Downloads the latest TensorFlow Docker base image. You
                                    can replace this with any Docker base image you want to bring to
                                    build containers, as well as with AWS pre-built container base
                                    images.</p>
                            </li><li class="listitem">
                                <p><code class="code">RUN pip install sagemaker-training</code> –
                                    Installs <a href="https://github.com/aws/sagemaker-training-toolkit" rel="noopener noreferrer" target="_blank"><span>SageMaker
                                        Training Toolkit</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> that contains the common
                                    functionality necessary to create a container compatible with
                                    SageMaker. </p>
                            </li><li class="listitem">
                                <p><code class="code">COPY train.py /opt/ml/code/train.py</code> –
                                    Copies the script to the location inside the container that is
                                    expected by SageMaker. The script must be located in this
                                    folder.</p>
                            </li><li class="listitem">
                                <p><code class="code">ENV SAGEMAKER_PROGRAM train.py</code> – Takes
                                    your training script <code>train.py</code> as the
                                    entrypoint script copied in the
                                        <code>/opt/ml/code</code> folder of the container.
                                    This is the only environmental variable that you must specify
                                    when you build your own container.</p>
                            </li></ul></div>
                    </li><li>
                        <p> On the left directory navigation pane, the text file name might
                            automatically be named <code class="code">untitled.txt</code>. To rename the file,
                            right-click the file, choose <b>Rename</b>, rename the
                            file as <code class="code">Dockerfile</code> without the <code class="code">.txt</code> extension,
                            and then press <code class="code">Ctrl+s</code> or <code class="code">Command+s</code> to save the
                            file.</p>
                    </li></ol>
            </li><li>
                <p>Upload a training script <code class="code">train.py</code> to the
                        <code class="code">docker_test_folder</code>. You can use the following example script to
                    create a model that reads handwritten digits trained on the <a href="https://en.wikipedia.org/wiki/MNIST_database" rel="noopener noreferrer" target="_blank"><span>MNIST dataset</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> for
                    this exercise.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python.py ">import tensorflow as tf
import os

mnist = tf.keras.datasets.mnist

(x_train, y_train), (x_test, y_test) = mnist.load_data()
x_train, x_test = x_train / 255.0, x_test / 255.0

model = tf.keras.models.Sequential([
tf.keras.layers.Flatten(input_shape=(28, 28)),
tf.keras.layers.Dense(128, activation='relu'),
tf.keras.layers.Dropout(0.2),
tf.keras.layers.Dense(10, activation='softmax')
])

model.compile(optimizer='adam',
loss='sparse_categorical_crossentropy',
metrics=['accuracy'])

model.fit(x_train, y_train, epochs=1)
model_save_dir = f"<span>{</span>os.environ.get('SM_MODEL_DIR')}/1"

model.evaluate(x_test, y_test)
tf.saved_model.save(model, model_save_dir)</code></pre>
            </li></ol></div>
     
        <h2 id="byoc-training-step3">Step 3: Build the container</h2>
        <div class="procedure"><ol><li>
                <p>In the JupyterLab home directory, open a Jupyter notebook. To open a new
                    notebook, choose the <b>New Launch</b> icon and then choose the
                    latest version of <b>conda_tensorflow2</b> in the
                        <b>Notebook</b> section.</p>
            </li><li>
                <p>Run the following command in the first notebook cell to change to the
                        <code>docker_test_folder</code> directory:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">cd ~/SageMaker/docker_test_folder</code></pre>
                <p>This returns your current directory as follows:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">! pwd</code></pre>
                <p><code class="code">output: /home/ec2-user/SageMaker/docker_test_folder</code></p>
            </li><li>
                <p>To build the Docker container, run the following Docker build command,
                    including the space followed by a period at the end:</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">! docker build -t tf-custom-container-test .</code></pre>
                <p>The Docker build command must be run from the Docker directory you created, in
                    this case <code>docker_test_folder</code>.</p>
                <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>If you get the following error message that Docker cannot find the
                        Dockerfile, make sure the Dockerfile has the correct name and has been saved
                        to the directory.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">unable to prepare context: unable to evaluate symlinks in Dockerfile path: 
lstat /home/ec2-user/SageMaker/docker/Dockerfile: no such file or directory</code></pre><p>Remember that <code class="code">docker</code> looks for a file specifically called
                            <code>Dockerfile</code> without any extension within the current
                        directory. If you named it something else, you can pass in the file name
                        manually with the <code class="code">-f</code> flag. For example, if you named your
                        Dockerfile as <code class="code">Dockerfile-text.txt</code>, run the following
                        command:</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">! docker build -t tf-custom-container-test -f Dockerfile-text.txt .</code></pre></div></div>
            </li></ol></div>
     
        <h2 id="byoc-training-step4">Step 4: Test the container</h2>
        <div class="procedure"><ol><li>
                <p>To test the container locally in the notebook instance, open a Jupyter
                    notebook. Choose <b>New Launcher</b> and choose the latest version
                    of <b>conda_tensorflow2</b> in the
                        <b>Notebook</b> section. </p>
            </li><li>
                <p>Paste the following example script into the notebook code cell to configure a
                    SageMaker Estimator.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">import sagemaker
from sagemaker.estimator import Estimator

estimator = Estimator(image_uri='<code class="replaceable">tf-custom-container-test</code>',
                      role=<code class="replaceable">sagemaker.get_execution_role()</code>,
                      instance_count=<code class="replaceable">1</code>,
                      instance_type=<code class="replaceable">'local'</code>)

estimator.fit()</code></pre>
                <p>In the preceding code example, <code class="code">sagemaker.get_execution_role()</code> is
                    specified to the <code class="code">role</code> argument to automatically retrieve the role
                    set up for the SageMaker session. You can also replace it with the string value of
                        <b>the IAM role ARN number</b> you used when you configured
                    the notebook instance. The ARN should look like the following:
                        <code class="code">'arn:aws:iam::111122223333:role/service-role/AmazonSageMaker-ExecutionRole-20190429T110788'</code>. </p>
            </li><li>
                <p>Run the code cell. This test outputs the training environment configuration,
                    the values used for the environmental variables, the source of the data, and the
                    loss and accuracy obtained during training.</p>
            </li></ol></div>
     
        <h2 id="byoc-training-step5">Step 5: Push the container to Amazon Elastic Container Registry
                (Amazon ECR)</h2>
        <div class="procedure"><ol><li>
                <p>After you successfully run the local mode test, you can push the Docker
                    container to <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/what-is-ecr.html">Amazon ECR</a> and use it
                    to run training jobs. If you want to use a private Docker registry instead of
                    Amazon ECR, see <a href="docker-containers-adapt-your-own-private-registry.html">Push your training container to a private registry</a>.</p>
                <p>Run the following command lines in a notebook cell.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">%%sh

# Specify an algorithm name
algorithm_name=<code class="userinput">tf-custom-container-test</code>

account=$(aws sts get-caller-identity --query Account --output text)

# Get the region defined in the current configuration (default to us-west-2 if none defined)
region=$(aws configure get region)
region=$<span>{</span>region:-us-west-2}

fullname="$<span>{</span>account}.dkr.ecr.$<span>{</span>region}.amazonaws.com/$<span>{</span>algorithm_name}:latest"

# If the repository doesn't exist in ECR, create it.

aws ecr describe-repositories --repository-names "$<span>{</span>algorithm_name}" &gt; /dev/null 2&gt;&amp;1
if [ $? -ne 0 ]
then
aws ecr create-repository --repository-name "$<span>{</span>algorithm_name}" &gt; /dev/null
fi

# Get the login command from ECR and execute it directly

aws ecr get-login-password --region $<span>{</span>region}|docker login --username AWS --password-stdin $<span>{</span>fullname}

# Build the docker image locally with the image name and then push it to ECR
# with the full name.

docker build -t $<span>{</span>algorithm_name} .
docker tag $<span>{</span>algorithm_name} $<span>{</span>fullname}

docker push $<span>{</span>fullname}</code></pre>
                <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>This bash shell script may raise a permission issue similar to the
                        following error message:</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">"denied: User: [ARN] is not authorized to perform: ecr:InitiateLayerUpload on resource:
arn:aws:ecr:us-east-1:[id]:repository/tf-custom-container-test"</code></pre><p>If this error occurs, you need to attach the
                            <b>AmazonEC2ContainerRegistryFullAccess</b> policy to your
                        IAM role. Go to the <a href="https://console.aws.amazon.com/iam/home" rel="noopener noreferrer" target="_blank"><span>IAM
                            console</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, choose <b>Roles</b> from the left
                        navigation pane, look up the IAMrole you used for the Notebook instance.
                        Under the <b>Permission</b> tab, choose the <b>Attach
                            policies</b> button, and search the
                            <b>AmazonEC2ContainerRegistryFullAccess</b> policy. Mark
                        the check box of the policy, and choose <b>Add permissions</b>
                        to finish.</p></div></div>
            </li><li>
                <p>Run the following code in a Studio notebook cell to call the Amazon ECR image of
                    your training container.</p>                
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">import boto3

account_id = boto3.client('sts').get_caller_identity().get('Account')
ecr_repository = 'tf-custom-container-test'
tag = ':latest'

region = boto3.session.Session().region_name

uri_suffix = 'amazonaws.com'
if region in ['cn-north-1', 'cn-northwest-1']:
    uri_suffix = 'amazonaws.com.cn'

byoc_image_uri = '<span>{</span>}.dkr.ecr.<span>{</span>}.<span>{</span>}/<span>{</span>}'.format(account_id, region, uri_suffix, ecr_repository + tag)

byoc_image_uri
# This should return something like
# 111122223333.dkr.ecr.us-east-2.amazonaws.com/sagemaker-byoc-test:latest</code></pre>
            </li><li>
                <p>Use the <code class="code">ecr_image</code> retrieved from the previous step to configure a
                    SageMaker estimator object. The following code sample configures a SageMaker estimator
                    with the <code class="code">byoc_image_uri</code> and initiates a training job on an Amazon EC2
                    instance.</p>
                <awsdocs-tabs><dl style="display: none">
                    <dt>SageMaker Python SDK v1</dt><dd tab-id="sagemaker-python-sdk-v1">
                            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">import sagemaker
from sagemaker import get_execution_role
from sagemaker.estimator import Estimator

estimator = Estimator(image_uri=byoc_image_uri,
                      role=get_execution_role(),
                      base_job_name='tf-custom-container-test-job',
                      instance_count=1,
                      instance_type='ml.g4dn.xlarge')

#train your model
estimator.fit()

</code></pre>
                        </dd>
                    <dt>SageMaker Python SDK v2</dt><dd tab-id="sagemaker-python-sdk-v2">
                            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="py ">import sagemaker
from sagemaker import get_execution_role
from sagemaker.estimator import Estimator

estimator = Estimator(image_uri=byoc_image_uri,
                      role=get_execution_role(),
                      base_job_name='tf-custom-container-test-job',
                      instance_count=1,
                      instance_type='ml.g4dn.xlarge')

#train your model
estimator.fit()
</code></pre>
                        </dd>
                </dl></awsdocs-tabs>
            </li><li>
                <p>If you want to deploy your model using your own container, refer to <a href="adapt-inference-container.html">Adapting Your Own
                        Inference Container</a>. You can also use an AWSframework container
                    that can deploy a TensorFlow model. To deploy the example model to read
                    handwritten digits, enter the following example script into the same notebook
                    that you used to train your model in the previous sub-step to obtain the image
                    URIs (universal resource identifiers) needed for deployment, and deploy the
                    model.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">import boto3
import sagemaker

#obtain image uris
from sagemaker import image_uris
container = image_uris.retrieve(framework='tensorflow',region='us-west-2',version='2.11.0',
                    image_scope='inference',instance_type='ml.g4dn.xlarge')

#create the model entity, endpoint configuration and endpoint
predictor = estimator.deploy(1,instance_type='ml.g4dn.xlarge',image_uri=container)</code></pre>
                <p>Test your model using a sample handwritten digit from the MNIST dataset using the following
                    code example.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">#Retrieve an example test dataset to test
import numpy as np
import matplotlib.pyplot as plt
from keras.datasets import mnist

# Load the MNIST dataset and split it into training and testing sets
(x_train, y_train), (x_test, y_test) = mnist.load_data()
# Select a random example from the training set
example_index = np.random.randint(0, x_train.shape[0])
example_image = x_train[example_index]
example_label = y_train[example_index]

# Print the label and show the image
print(f"Label: <span>{</span>example_label}")
plt.imshow(example_image, cmap='gray')
plt.show()</code></pre>
                <p>Convert the test handwritten digit into a form that TensorFlow can ingest and
                    make a test prediction.</p>
                <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="">from sagemaker.serializers import JSONSerializer
data = <span>{</span>"instances": example_image.tolist()}
predictor.serializer=JSONSerializer() #update the predictor to use the JSONSerializer
predictor.predict(data) #make the prediction</code></pre>
            </li></ol></div>
        <p>For a full example that shows how to test a custom container locally and push it to an
            Amazon ECR image, see the <a href="https://sagemaker-examples.readthedocs.io/en/latest/advanced_functionality/tensorflow_bring_your_own/tensorflow_bring_your_own.html" rel="noopener noreferrer" target="_blank"><span> Building Your Own TensorFlow Container</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> example notebook.</p>
        <div class="awsdocs-note awsdocs-tip"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Tip</h6></div><div class="awsdocs-note-text"><p>To profile and debug training jobs to monitor system utilization issues (such as
                CPU bottlenecks and GPU underutilization) and identify training issues (such as
                overfitting, overtraining, exploding tensors, and vanishing gradients), use Amazon SageMaker Debugger.
                For more information, see <a href="debugger-bring-your-own-container.html">Use Debugger with Custom Training
            Containers</a>.</p></div></div>
     
        <h2 id="byoc-training-step6">Step 6: Clean up resources</h2>
        <div class="procedure"><h6>To clean up resources when done with the get started example</h6><ol><li>
                <p>Open the <a href="https://console.aws.amazon.com/sagemaker/" rel="noopener noreferrer" target="_blank"><span>SageMaker console</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>, choose
                    the notebook instance <b>RunScriptNotebookInstance</b>, choose
                        <b>Actions</b>, and choose <b>Stop</b>. It can
                    take a few minutes for the instance to stop. </p>
            </li><li>
                <p>After the instance <b>Status</b> changes to
                        <b>Stopped</b>, choose <b>Actions</b>, choose
                        <b>Delete</b>, and then choose <b>Delete</b> in
                    the dialog box. It can take a few minutes for the instance to be deleted. The
                    notebook instance disappears from the table when it has been deleted. </p>
            </li><li>
                <p>Open the <a href="https://console.aws.amazon.com/s3/" rel="noopener noreferrer" target="_blank"><span>Amazon S3 console</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> and delete the
                    bucket that you created for storing model artifacts and the training dataset.
                </p>
            </li><li>
                <p>Open the <a href="https://console.aws.amazon.com/iam/" rel="noopener noreferrer" target="_blank"><span>IAM console</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> and delete the
                    IAM role. If you created permission policies, you can delete them, too. </p>
                <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p> The Docker container shuts down automatically after it has run. You don't
                        need to delete it.</p></div></div>
            </li></ol></div>
     
        <h2 id="byoc-blogs-and-examples">Blogs and Case Studies</h2>
        <p>The following blogs discuss case studies about using custom training containers in
            Amazon SageMaker.</p>
        <div class="itemizedlist">
             
        <ul class="itemizedlist"><li class="listitem">
                <p><a href="https://medium.com/@pandey.vikesh/why-bring-your-own-container-to-amazon-sagemaker-and-how-to-do-it-right-bc158fe41ed1" rel="noopener noreferrer" target="_blank"><span>Why bring your own container to Amazon SageMaker and how to do it right</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>,
                        <em>Medium</em> (January 20th, 2023)</p>
            </li></ul></div>
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="https://docs.aws.amazon.com/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./amazon-sagemaker-toolkits.html">SageMaker Training and Inference Toolkits</div><div id="next" class="next-link" accesskey="n" href="./docker-containers-adapt-your-own-private-registry.html">Adapt your training
                job to access images in a private Docker registry</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=https://docs.aws.amazon.com/en_us/sagemaker/latest/dg/adapt-training-container.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=SageMaker&amp;topic_url=https://docs.aws.amazon.com/en_us/sagemaker/latest/dg/adapt-training-container.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>